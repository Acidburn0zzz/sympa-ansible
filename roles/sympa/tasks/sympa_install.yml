---

- name: Add sympa user
  user: name=sympa group=sympa password=no
  
- name: Create sympa directories
  file: dest=/home/{{ item }} state=directory mode=755 owner=sympa
  with_items: ['sympa', 'sympa/src']

- name: Check Sympa tar.gz existence
  stat: path="/home/sympa/src/sympa-{{ sympa_version }}.tar.gz"
  register: sympa_archive_file

- name: Download Sympa tar.gz
  get_url:
    url: "{{ sympa_download_url }}"
    dest: "/home/sympa/src"
    sha256sum: "{{ sympa_sha256 }}"
  when: not sympa_archive_file.stat.exists

- name: Create the Sympa src directory
  file: path=/home/sympa/src/sympa-{{ sympa_version }} state=directory
  
- name: Unpack the tarball
  unarchive: src=/home/sympa/src/sympa-{{ sympa_version }}.tar.gz dest=/home/sympa/src/ copy=no creates=/home/sympa/src/sympa-{{ sympa_version }}/README
  
- name: Install Sympa
  shell: ./configure --with-lockdir=/var/lock --with-initdir=/etc/init.d  && make && make install
  args:
    chdir: "/home/sympa/src/sympa-{{ sympa_version }}"
    executable: /bin/bash

- name: Install Sympa configuration file
  template: src=sympa.conf.j2 dest=/etc/sympa/sympa.conf owner=sympa group=sympa mode=0640
  tags: sympa_conf
  notify: restart sympa
  
- name: Enable Sympa on boot
  service: name=sympa enabled=yes
  
- name: Install custom rsyslog conf file
  template: src=rsyslog/sympa.conf.j2 dest=/etc/rsyslog.d/sympa.conf mode=0644
  tags: syslog
  notify: restart rsyslog

- name: Configure logrotate
  template: src=logrotate/sympa.j2 dest=/etc/logrotate.d/sympa mode=0644
  tags: logrotate
  